<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Weather Crisis Resource Allocation</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:1200px; margin:24px auto; padding:0 16px; color:#111; }
    h1 { margin-bottom:8px; }
    .tabs { display:flex; gap:8px; margin-bottom:16px; }
    .tab { padding:8px 12px; border-radius:8px; cursor:pointer; background:#eee; }
    .tab.active { background:#0b74de; color:white; }
    .panel { display:none; padding:12px 0; border-top:1px solid #ddd; }
    .panel.active { display:block; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .region-block { border:1px solid #ddd; padding:10px; margin-bottom:8px; border-radius:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:14px; }
    input[type="text"], input[type="number"] { padding:6px 8px; border-radius:4px; border:1px solid #bbb; min-width:90px; }
    button { padding:8px 12px; border-radius:6px; border:0; background:#0b74de; color:white; cursor:pointer; }
    button.ghost { background:#eee; color:#111; }
    .small { padding:6px 8px; font-size:13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    pre { background:#f7f7f7; padding:12px; border-radius:6px; border:1px solid #eee; max-height:360px; overflow:auto; }
    .muted { color:#666; font-size:13px; }
    .error { color:crimson; }
    table input { width:70px; }
  </style>
</head>
<body>
  <h1>Weather Crisis Resource Allocation</h1>
  <p class="muted">Choose an algorithm tab, enter region data and depot supply, then run the algorithm. Max-flow uses a capacity matrix with source/sink indices.</p>

  <div class="tabs">
    <div class="tab active" data-panel="panel-regions">Regions (shared)</div>
    <div class="tab" data-panel="panel-greedy">Greedy</div>
    <div class="tab" data-panel="panel-knapsack">Knapsack</div>
    <div class="tab" data-panel="panel-maxflow">Max-Flow</div>
  </div>

  <!-- Shared region input panel -->
  <div id="panel-regions" class="panel active">
    <h2>Regions & Depot (shared)</h2>
    <div style="margin-bottom:6px;">
      <button onclick="addRegion()" class="small">+ Add Region</button>
      <button onclick="clearRegions()" class="small ghost">Clear</button>
      <span class="muted" style="margin-left:12px;">You can add many regions. Each region needs <strong>name</strong>, <strong>need</strong> (resources) and <strong>urgency</strong> (priority score).</span>
    </div>

    <div id="regionsContainer"></div>

    <div style="margin-top:12px;">
      <label>Depot Supply:</label>
      <input id="depotSupply" type="number" value="60" min="0">
      <span class="muted" style="margin-left:8px;">Total supply available at depot</span>
    </div>
  </div>

  <!-- Greedy panel -->
  <div id="panel-greedy" class="panel">
    <h2>Greedy Allocation</h2>
    <p class="muted">Allocates supplies greedily by urgency (higher urgency first).</p>
    <div class="controls" style="margin-top:8px;">
      <button onclick="runGreedy()">Run Greedy</button>
      <button onclick="downloadJSON('greedy')" class="ghost small">Download payload</button>
      <div id="greedyStatus" class="muted"></div>
    </div>
    <h3>Result</h3>
    <pre id="greedyOutput">{ }</pre>
  </div>

  <!-- Knapsack panel -->
  <div id="panel-knapsack" class="panel">
    <h2>Knapsack (0/1)</h2>
    <p class="muted">Select regions to maximize total urgency under the depot capacity constraint (each region is indivisible here).</p>
    <div class="controls" style="margin-top:8px;">
      <button onclick="runKnapsack()">Run Knapsack</button>
      <button onclick="downloadJSON('knapsack')" class="ghost small">Download payload</button>
      <div id="knapsackStatus" class="muted"></div>
    </div>
    <h3>Result</h3>
    <pre id="knapsackOutput">{ }</pre>
  </div>

  <!-- Max-flow panel -->
  <div id="panel-maxflow" class="panel">
    <h2>Max-Flow (Edmonds–Karp)</h2>
    <p class="muted">Build a directed capacity matrix and choose source/sink node indices (0-based).</p>

    <div class="controls" style="margin:8px 0 12px 0;">
      <label>Nodes:</label>
      <input id="nodeCount" type="number" min="2" value="4">
      <button onclick="buildMatrix()" class="small">Build Matrix</button>
      <span class="muted" style="margin-left:8px;">Matrix is <strong>n × n</strong> where entry (i,j) is capacity from i → j.</span>
    </div>

    <div id="matrixContainer"></div>

    <div style="margin-top:8px;">
      <label>Source:</label>
      <input id="sourceNode" type="number" min="0" value="0">
      <label style="margin-left:12px;">Sink:</label>
      <input id="sinkNode" type="number" min="0" value="3">
      <button onclick="runMaxflow()" style="margin-left:12px;">Run Max-Flow</button>
    </div>

    <h3>Result</h3>
    <pre id="maxflowOutput">{ }</pre>
  </div>

  <script>
    // ---------- Tabs ----------
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

        tab.classList.add('active');
        const panelId = tab.getAttribute('data-panel');
        document.getElementById(panelId).classList.add('active');
      });
    });

    // ---------- Dynamic Regions ----------
    const regionsContainer = document.getElementById('regionsContainer');

    function addRegion(name = '', need = 10, urgency = 1) {
      const id = Date.now().toString(36) + Math.floor(Math.random()*1000);
      const div = document.createElement('div');
      div.className = 'region-block';
      div.dataset.id = id;
      div.innerHTML = `
        <label style="min-width:80px">Name</label>
        <input class="r_name" type="text" value="${name}" placeholder="Region name">
        <label>Need</label>
        <input class="r_need" type="number" value="${need}" min="0">
        <label>Urgency</label>
        <input class="r_urgency" type="number" value="${urgency}" min="0">
        <button class="small ghost" onclick="removeRegion(this)">Remove</button>
      `;
      regionsContainer.appendChild(div);
    }

    function removeRegion(btn) {
      const block = btn.closest('.region-block');
      if (block) block.remove();
    }

    function clearRegions() {
      regionsContainer.innerHTML = '';
    }

    // Add some defaults
    clearRegions();
    addRegion('Region A', 40, 9);
    addRegion('Region B', 30, 5);
    addRegion('Region C', 20, 7);

    // ---------- Helpers ----------
    function collectRegions() {
      const blocks = document.querySelectorAll('.region-block');
      const regions = [];
      blocks.forEach(b => {
        const name = b.querySelector('.r_name').value || 'Unnamed';
        const need = parseInt(b.querySelector('.r_need').value) || 0;
        const urgency = parseInt(b.querySelector('.r_urgency').value) || 0;
        regions.push({ name, need, urgency });
      });
      return regions;
    }

    function getDepot() {
      return { name: 'Central Depot', supply: Math.max(0, parseInt(document.getElementById('depotSupply').value) || 0) };
    }

    function showPre(id, obj) {
      document.getElementById(id).textContent = JSON.stringify(obj, null, 2);
    }

    function showError(id, msg) {
      document.getElementById(id).textContent = 'Error: ' + msg;
    }

    function downloadJSON(mode) {
      const payload = { regions: collectRegions(), depot: getDepot() };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
      const a = document.createElement('a');
      a.setAttribute('href', dataStr);
      a.setAttribute('download', mode + '-payload.json');
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ---------- GREEDY ----------
    async function runGreedy() {
      const payload = { regions: collectRegions(), depot: getDepot() };
      document.getElementById('greedyStatus').textContent = 'Running...';
      try {
        const res = await fetch('/allocate/greedy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(res.statusText || 'Network error');
        const data = await res.json();
        showPre('greedyOutput', data);
        document.getElementById('greedyStatus').textContent = 'Done';
      } catch (e) {
        showError('greedyOutput', e.message || e);
        document.getElementById('greedyStatus').textContent = '';
      }
    }

    // ---------- KNAPSACK ----------
    async function runKnapsack() {
      const payload = { regions: collectRegions(), depot: getDepot() };
      document.getElementById('knapsackStatus').textContent = 'Running...';
      try {
        const res = await fetch('/allocate/knapsack', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(res.statusText || 'Network error');
        const data = await res.json();
        showPre('knapsackOutput', data);
        document.getElementById('knapsackStatus').textContent = 'Done';
      } catch (e) {
        showError('knapsackOutput', e.message || e);
        document.getElementById('knapsackStatus').textContent = '';
      }
    }

    // ---------- MAX-FLOW UI ----------
    function buildMatrix() {
      const n = Math.max(2, parseInt(document.getElementById('nodeCount').value) || 4);
      const container = document.getElementById('matrixContainer');
      container.innerHTML = '';

      // build table
      const table = document.createElement('table');
      table.setAttribute('border', '1');
      table.style.borderCollapse = 'collapse';
      table.style.marginBottom = '8px';
      const tbody = document.createElement('tbody');

      for (let i = 0; i < n; i++) {
        const tr = document.createElement('tr');
        for (let j = 0; j < n; j++) {
          const td = document.createElement('td');
          td.style.padding = '4px';
          const input = document.createElement('input');
          input.type = 'number';
          input.min = 0;
          input.value = (i === j) ? 0 : 0;
          input.id = `cell_${i}_${j}`;
          input.style.width = '70px';
          td.appendChild(input);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // build initial matrix
    buildMatrix();

    async function runMaxflow() {
      const n = Math.max(2, parseInt(document.getElementById('nodeCount').value) || 4);
      const capacity = [];
      for (let i = 0; i < n; i++) {
        const row = [];
        for (let j = 0; j < n; j++) {
          const v = parseInt(document.getElementById(`cell_${i}_${j}`).value);
          row.push(Number.isFinite(v) ? v : 0);
        }
        capacity.push(row);
      }

      const source = parseInt(document.getElementById('sourceNode').value);
      const sink = parseInt(document.getElementById('sinkNode').value);

      // basic validation
      if (isNaN(source) || isNaN(sink) || source < 0 || sink < 0 || source >= n || sink >= n) {
        showError('maxflowOutput', 'Source and sink must be valid node indices (0..n-1)');
        return;
      }
      if (source === sink) {
        showError('maxflowOutput', 'Source and sink must be different nodes.');
        return;
      }

      const payload = { capacity, source, sink };

      try {
        const res = await fetch('/route/maxflow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(res.statusText || 'Network error');
        const data = await res.json();
        showPre('maxflowOutput', data);
      } catch (e) {
        showError('maxflowOutput', e.message || e);
      }
    }

    // Convenience: press Ctrl+Enter runs active panel's default action
    window.addEventListener('keydown', (ev) => {
      if (ev.ctrlKey && ev.key === 'Enter') {
        const activePanel = document.querySelector('.panel.active');
        if (activePanel && activePanel.id === 'panel-greedy') runGreedy();
        if (activePanel && activePanel.id === 'panel-knapsack') runKnapsack();
        if (activePanel && activePanel.id === 'panel-maxflow') runMaxflow();
      }
    });

  </script>
</body>
</html>
